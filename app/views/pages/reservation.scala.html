@import  ecat.util.DateTime.{pertrovichDateTimeFormatter=>fmt}

@(from:String, to:String)(implicit req: play.api.mvc.RequestHeader)

@helper.javascriptRouter("jsRoutes")(routes.javascript.Application.getDummyOffers, routes.javascript.Application.category, routes.javascript.Application.filter)

<!--move javascript router to main wrapping template -->
<!DOCTYPE html>
<html lang="en">
<head>
  @views.html.commoncss.render("Бронирование")
</head>

<body class="page-reservation">

  <div class="wrapper">

    @views.html.base_top.render

    <main class="main-fluid clearfix">

      <div class="contact-box">
        <h2>Отель Екатерина</h2>
        <p>Украина, 65026, г. Одесса, ул. Греческая 25/11</p>
        <h3>Отдел бронирования:</h3>
        <p><a href="tel:+380487296701">+38 (048) 729-67-01</a></p>
        <p><a href="tel:+380671815104">+38 (067) 181-51-04</a></p>
        <h3>Рецепция:</h3>
        <p><a href="tel:+380487296703">+38 (048) 729-67-03</a></p>
        <p><a href="tel:+380487226408">+38 (048) 722-64-08</a></p>
        <p>факс: +38 (048) 729-67-08</p>
        <p><a href="mailto:booking@@hotel-ekaterina.com">Email: booking@@hotel-ekaterina.com</a></p>
        <h2>Отель Екатерина II</h2>
        <p>Украина, 65026, г. Одесса, площадь Екатерининская, 7</p>
        <h3>Отдел бронирования:</h3>
        <p><a href="tel:+380487296702">+38 (048) 729-67-02</a></p>
        <p><a href="tel:+380671815105">+38 (067) 181-51-05</a></p>
        <h3>Рецепция:</h3>
        <p><a href="tel:+380487296700">+38 (048) 729-67-00</a></p>
        <p>факс: +38 (048) 729-67-08</p>
        <p><a href="mailto:booking@@hotel-ekaterina.com">Email: booking@@hotel-ekaterina.com</a></p>
      </div>

      <section class="main-section clearfix">

        <h1>Забронируйте номер</h1>

        <form action="#" class="booking-form clearfix" id="filterBlock">

          <fieldset>
            <div class="booking-row clearfix">

              <div class="form-col">
                <label for="checkIn">Дата заселения <i class="flaticon-calendar-icons"></i></label>
                <input type="text" name="checkIn" id="checkIn" value="Дата заселения" required readonly>
              </div>

              <div class="form-col">
                <label for="checkOut">Дата выселения <i class="flaticon-calendar-icons"></i></label>
                <input type="text" name="checkOut" id="checkOut" value="Дата выселения" required readonly>
              </div>

              <div class="form-col">
                <label for="peopleQuantity">Кол-во человек</label>
                <select name="peopleQuantity" id="peopleQuantity" required>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>

              <div class="form-col">
                <label for="hotel">Отель</label>
                <select name="hotel" id="hotel" required>
                  <option value="">Все</option>
                  <option value="Екатерина">Екатерина</option>
                  <option value="Екатерина II">Екатерина II</option>
                </select>
              </div>

              <div class="form-col">
                <label for="twin">Твин</label>
                <input type="checkbox" name="twin" id="twin">
              </div>

              <div class="form-col">
                <div class="submit-button">
                  <input type="submit" value="Заказать">
                </div>
              </div>

            </div>

          </fieldset>

        </form>

      </section>



    </main>

  </div>

  @views.html.base_bottom.render(false)

  <script>

  var beautySelect = function () {
    $('select').selectric({
      responsive: true
    });
  };

  var globalFilt = {};

    var elemAndVal = function (container, selector, valueType) {
      console.time('elemAndVal');
      var result = {};
      result.element = container.querySelector(selector);

      result.value = (function () {
        if (result.element.type === 'checkbox') {
          console.timeEnd('elemAndVal');
          return result.element.checked ? true : false;
        }

        if(result.element.tagName === "SELECT" || result.element.tagName === "INPUT") {
          console.timeEnd('elemAndVal');
          return result.element.value;
        }

        console.timeEnd('elemAndVal');
        return result.element.text;

      })();

      if (valueType === 'number') {
        result.value = +result.value
      }

      console.timeEnd('elemAndVal');

      return result;

    };

    var collectOpts = function (cat) {
      console.time('collectOpts');

      var options = {

        breakfast: elemAndVal(cat, '[data-breakfast]'),

        eci: elemAndVal(cat, '[data-eci]'),

        lco: elemAndVal(cat, '[data-lco]'),

        guestsCnt: elemAndVal(cat, '[data-guestscnt]', 'number'),

        roomCnt: elemAndVal(cat, '[data-roomcnt]', 'number'),

        price: elemAndVal(cat, '[data-price]', 'number'),

        hotelId: (cat).dataset.hotelid,

        catId: (cat).dataset.catid,

        hash: +(cat).dataset.hash

      };
      console.timeEnd('collectOpts');
      return options;

    };

    var collectFilters = function (elem) {
      console.time('collectFilters');
      var filters = {
        from: function () {
          return elemAndVal(elem, '#checkIn').value.replace(/\./g,'') + '000000';
        },
        to: function () {
          return elemAndVal(elem, '#checkOut').value.replace(/\./g,'') + '000000';
        },
        hotel: {
          name: elemAndVal(elem, '#hotel').value
        },
        room: {
          twin: elemAndVal(elem, '#twin').value,
          guests: elemAndVal(elem, '#peopleQuantity', 'number').value
        }
      };
      if (filters.hotel.name === '') delete filters.hotel.name;
      if (filters.room.twin === false) delete filters.room.twin;
      globalFilt = {
        hotel: filters.hotel,
        room: filters.room,
        opt: []
      };
      console.timeEnd('collectFilters');
      console.log(filters);
      return filters;
    };

    var stringOpts = function (cat) {
      console.time('stringOpts');

      var opt = collectOpts(cat);

      var data = JSON.stringify({
          'hotelId'  : opt.hotelId,
          'catId'    : opt.catId,
          'hash'     : opt.hash,
          'guestsCnt': opt.guestsCnt.value,
          'roomCnt'  : opt.roomCnt.value,
          'bkf'      : opt.breakfast.value,
          'eci'      : opt.eci.value,
          'lco'      : opt.lco.value,
          'hotel'    : globalFilt.hotel,
          'room'     : globalFilt.room,
          'opt'      : globalFilt.opt
      });
      console.timeEnd('stringOpts');
      return data;

    };

    // ***************** Setup Options ***************************

    var changeSelect = function (container, elem, maxCnt) {
      console.time('changeSelect');

      if ($(container).find(elem + 'option').length !== maxCnt) {
        (function () {
          var i       = 0,
              $select = $(container).find(elem),
              value   = $select.val();
          $select.html('');
          for (;i < maxCnt; i++) {
            var $option = $('<option>');
            $option.val(i + 1).text(i + 1);
            $select.append($option);
          }

          $select.val(value);

          console.timeEnd('changeSelect');
        })()
      }

    };

    var setupOpt = function (data, cat) {
      console.time('setupOpt');

      changeSelect(cat, '[data-guestscnt]', data.maxGuestCnt);

      changeSelect(cat, '[data-roomcnt]', data.maxRoomCnt);

      console.timeEnd('setupOpt');

    };

    // ***************************End of setup options***********************

    var changeCat = function (cat) {
      console.time('changeCat');

      cat = cat || '.category-list';

      $(cat).change(function(e) {

        var from    = @from,
            to      = @to,
            cat     = $('.category-item').has(e.target)[0],
            reqData = stringOpts(cat);

            console.log(reqData);

        $.ajax(jsRoutes.controllers.Application.category(from, to, reqData))
        .done(function( resp ) {

          resp.changed ? (function () {
            alert('Категория изменилась!');
            var category = resp.categoryHtml;
            $(cat).replaceWith(category);
            console.log($(category).attr('data-catid'));
            changeCat('[data-catid=' + $(category).attr('data-catid') + ']');
          })() :
          console.log(resp.price);
          $(cat).find('[data-price]').text(resp.price);

           setupOpt(resp, cat);

           beautySelect();
           console.timeEnd('changeCat');
        });

      });
    };

    var changeFilter = function (selector) {
      console.time('changeFilter');
      $(selector).change(function(e) {
        var from      = @from,
            to        = @to,
            container = e.currentTarget,
            req       = collectFilters(selector);

            console.log(req.from() + " : " + req.to() + " : " + JSON.stringify(req.hotel) + " : " + JSON.stringify(req.room) + " : " + '[]');

            $.ajax(jsRoutes.controllers.Application.filter(req.from(), req.to(), JSON.stringify(req.hotel), JSON.stringify(req.room), '[]'))
            .done(function( response ) {

              $('.category-list').replaceWith(response);

              beautySelect();

              changeCat();
              console.timeEnd('changeFilter');
            });
      });
    };

//   ************************Starting dynamic****************************

    $.ajax(jsRoutes.controllers.Application.getDummyOffers(@from, @to))
      .done(function( resp ) {
        $('.booking-form').after(resp);

        $('#checkIn').val(moment((@from).toString().slice(0,-6)).format('YYYY.MM.DD'));
        $('#checkOut').val(moment((@to).toString().slice(0,-6)).format('YYYY.MM.DD'));

        beautySelect();

        changeCat('.category-list');

        changeFilter($('.booking-form')[0]);

        (function () {
          var min = $('#checkIn').val();
          var max = $('#checkOut').val();
          console.log('checkIn value: ' + min);
          $('#checkOut').datetimepicker({
              format:'YYYY.MM.DD',
              formatDate:'YYYY.MM.DD',
              timepicker:false,
              validateOnBlur: true,
              scrollMonth: false,
              scrollTime: false,
              minDate: min
          });

          $('#checkIn').datetimepicker({
              format:'YYYY.MM.DD',
              formatDate:'YYYY.MM.DD',
              timepicker:false,
              validateOnBlur: true,
              scrollMonth: false,
              scrollTime: false,
              minDate: 0,
              maxDate: max
          });

        })();

    });

  </script>

</body>
</html>
